Private Sub CommandButton1_Click()
    Call 批量添加水印
    Call ConvertWordsToPdfs
End Sub

Sub 批量添加水印()
    Dim fd As FileDialog
    Dim fd1 As FileDialog
    Dim fso As Object
    Dim arr() As String ' 存储每次遍历到的文件夹的子文件夹
    Dim brr() As String ' 临时存储每次遍历到的文件夹的子文件夹
    Dim crr() As String ' 存储所有文件夹
    Dim drr() As String ' 存储所有Word文件路径
    Dim myFolder As Object
    Dim subFolder As Variant
    Dim i As Long
    Dim j As Long
    Dim m As Long
    Dim myFile As Object
    Dim 后缀 As String
    Dim t0 As Single
    Dim 水印图片路径 As String

    t0 = Timer
    i = 0: j = 0: m = 0
    Set fd = Application.FileDialog(msoFileDialogFolderPicker)
    Set fso = CreateObject("Scripting.FileSystemObject")

    With fd
        .Title = "选择要添加水印的文件夹"
        If .Show Then
            i = i + 1
            ReDim Preserve crr(1 To i)
            crr(i) = .SelectedItems(1)
            arr = crr

            ' 存储文件夹路径到全局变量
            watermarkFolderPath = .SelectedItems(1)

            Set fd1 = Application.FileDialog(msoFileDialogFilePicker)
            With fd1
                .AllowMultiSelect = False
                .Title = "选择图片水印文件"
                .Filters.Clear
                .Filters.Add "图片文件", "*.png;*.jpeg;*.jpg", 1
                .Filters.Add "所有文件", "*.*", 2
                If .Show Then
                    水印图片路径 = .SelectedItems(1)
                End If
            End With
            Set fd1 = Nothing

            On Error Resume Next
            Do While Err.Number = 0
                For j = LBound(arr) To UBound(arr)
                    Set myFolder = fso.GetFolder(arr(j))
                    If myFolder.subFolders.Count > 0 Then
                        For Each subFolder In myFolder.subFolders
                            i = i + 1
                            ReDim Preserve crr(1 To i)
                            crr(i) = subFolder.Path

                            m = m + 1
                            ReDim Preserve brr(1 To m)
                            brr(m) = subFolder.Path
                        Next
                    End If
                Next
                m = 0
                arr = brr
                Erase brr
            Loop
            On Error GoTo 0

            i = 0
            For j = LBound(crr) To UBound(crr)
                Set myFolder = fso.GetFolder(crr(j))
                For Each myFile In myFolder.Files
                    后缀 = fso.GetExtensionName(myFile.Path)
                    If 后缀 Like "doc*" And Not 后缀 Like "*~$*" Then
                        i = i + 1
                        ReDim Preserve drr(1 To i)
                        drr(i) = myFile.Path
                    End If
                Next
            Next

            For j = LBound(drr) To UBound(drr)
                Application.ScreenUpdating = False
                On Error Resume Next
                调用处理过程 drr(j), 水印图片路径
                On Error GoTo ErrorHandler
                Application.ScreenUpdating = True
                Debug.Print Format(j, String(Len(CStr(UBound(drr))), "0")), drr(j), "添加水印完成"
            Next
        End If
    End With

    Set fd = Nothing
    Set fso = Nothing
    Set myFolder = Nothing

    MsgBox "完成   共对 " & UBound(drr) & " 份文件添加了水印   用时 " & Timer - t0 & " 秒", vbInformation
    Exit Sub

ErrorHandler:
    MsgBox "处理文件 " & drr(j) & " 时出现异常：" & Err.Description, vbExclamation
    On Error GoTo 0
    Resume NextFile

NextFile:
    Resume Next
End Sub

Sub 调用处理过程(文件名, 水印图片路径 As String)
    On Error Resume Next
    Dim aDoc As Document
    Set aDoc = Documents.Open(文件名)

    If Err.Number <> 0 Then
        MsgBox "Error opening document: " & 文件名 & vbCrLf & Err.Description, vbExclamation
        Err.Clear
    Else
        On Error GoTo ErrorHandler
        调用处理过程_具体操作 aDoc, 水印图片路径
        aDoc.Save
        aDoc.Close wdSaveChanges
    End If

    Set aDoc = Nothing
    On Error GoTo 0
    Exit Sub

ErrorHandler:
    MsgBox "处理文件 " & 文件名 & " 时出现异常：" & Err.Description, vbExclamation
    On Error GoTo 0
End Sub

Sub 调用处理过程_具体操作(aDoc As Document, 水印图片路径 As String)
    Dim sec As Section
    Dim hf As HeaderFooter
    Dim fso As Object
    Dim fNewName As String

    Set fso = CreateObject("Scripting.FileSystemObject")
    fNewName = fso.BuildPath(fso.GetParentFolderName(aDoc.FullName), _
               fso.GetBaseName(aDoc.FullName) & "_W." & fso.GetExtensionName(aDoc.FullName))

    For Each sec In aDoc.Sections
        For Each hf In sec.Headers
            添加图片水印 hf, 水印图片路径
        Next
    Next

    ' Save the modified document with the original filename
    aDoc.Save
    Exit Sub

ErrorHandler:
    MsgBox "处理文件 " & aDoc.FullName & " 时出现异常：" & Err.Description, vbExclamation
    On Error GoTo 0
End Sub

Sub 添加图片水印(hf As HeaderFooter, 水印图片路径 As String)
    On Error Resume Next
    Dim shape As shape
    Dim originalLineStyle As Long

    originalLineStyle = hf.Range.ParagraphFormat.Borders.InsideLineStyle
    Set shape = hf.Shapes.AddPicture(FileName:=水印图片路径, linktofile:=False, savewithdocument:=True)

    With shape
        .LockAspectRatio = True
        .WrapFormat.Side = wdWrapNone
        .WrapFormat.Type = wdWrapBehind
        .RelativeHorizontalPosition = wdRelativeHorizontalPositionPage
        .RelativeVerticalPosition = wdRelativeVerticalPositionPage
        .Left = wdShapeCenter
        .Top = wdShapeCenter

        ' 设置水印大小与页面相同
        .Width = ActiveDocument.PageSetup.PageWidth
        .Height = ActiveDocument.PageSetup.PageHeight
    End With

    ' Restore the original line style after adding the picture
    hf.Range.ParagraphFormat.Borders.InsideLineStyle = originalLineStyle
End Sub

Sub ConvertWordsToPdfs()
    Dim xIndex As String
    Dim xDlg As FileDialog
    Dim xFolder As Variant
    Dim xNewName As String
    Dim xFileName As String
    Dim startTime As Double
    Dim endTime As Double

    ' 提示用户选择 Word 转化 PDF 的文件夹
    Set xDlg = Application.FileDialog(msoFileDialogFolderPicker)
    xDlg.Title = "请选择 Word 转化 PDF 的文件夹"
    If xDlg.Show <> -1 Then Exit Sub
    xFolder = xDlg.SelectedItems(1) & "\"

    ' 获取文件夹中的第一个文件
    xFileName = Dir(xFolder & "*.*", vbNormal)

    ' 记录开始时间
    startTime = Timer

    ' 遍历文件夹中的所有文件
    While xFileName <> ""
        ' 检查文件扩展名是否为 .doc 或 .docx
        If ((Right(xFileName, 4)) = ".doc" Or Right(xFileName, 5) = ".docx") Then
            ' 构造新的文件名
            xIndex = InStrRev(xFileName, ".")
            xNewName = Left(xFileName, xIndex - 1) & ".pdf"
            
            ' 打开 Word 文档
            On Error Resume Next
            Documents.Open FileName:=xFolder & xFileName, _
                ConfirmConversions:=False, ReadOnly:=False, AddToRecentFiles:=False, _
                PasswordDocument:="", PasswordTemplate:="", Revert:=False, _
                WritePasswordDocument:="", WritePasswordTemplate:="", Format:= _
                wdOpenFormatAuto, XMLTransform:=""
            If Err.Number <> 0 Then
                ' 在发生错误时显示错误消息并退出所有 Word 进程
                MsgBox "无法打开文件：" & xFileName & vbCrLf & "错误消息：" & Err.Description, vbExclamation
                Exit Sub
            End If
            
            ' 导出为 PDF
            ActiveDocument.ExportAsFixedFormat OutputFileName:=xFolder & xNewName, _
                ExportFormat:=wdExportFormatPDF, OpenAfterExport:=False, OptimizeFor:= _
                wdExportOptimizeForPrint, Range:=wdExportAllDocument, From:=1, To:=1, _
                Item:=wdExportDocumentContent, IncludeDocProps:=True, KeepIRM:=True, _
                CreateBookmarks:=wdExportCreateNoBookmarks, DocStructureTags:=True, _
                BitmapMissingFonts:=True, UseISO19005_1:=False
            
            ' 关闭 Word 文档
            ActiveDocument.Close SaveChanges:=False
        End If
        
        ' 获取下一个文件
        xFileName = Dir()
    Wend
    
    ' 记录结束时间
    endTime = Timer

    ' 显示转换完成消息和转化时间
    MsgBox "转换完成！" & vbCrLf & "转化时间：" & Format(endTime - startTime, "0.00") & " 秒", vbInformation
End Sub

